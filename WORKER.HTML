<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Worker Dashboard ‚Äî Recycler</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2m0b0yCk3Qk8v+g1qfQ4o4gK1pF5QY7f5kP8mYQ=" crossorigin=""/>
  <style>
    :root{--green:#4caf50;--green-dark:#3a9e40;--bg:#eef7ee}
    body{margin:0;font-family:Inter, Arial, sans-serif;background:var(--bg);color:#223}
    .sidebar{width:240px;background:var(--green);color:#fff;height:100vh;position:fixed;padding-top:18px}
    .sidebar h3{text-align:center;margin:0 10px 18px}
    .nav-link{display:block;padding:12px 18px;color:#fff;text-decoration:none}
    .nav-link:hover{background:var(--green-dark)}
    .content{margin-left:240px;padding:22px}
    .top-row{display:flex;gap:18px;flex-wrap:wrap;align-items:center}
    .card{background:#fff;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,0.08);flex:1;min-width:240px}
    .card.small{flex:0 0 220px}
    .section{margin-top:18px}
    .feature-row{display:flex;gap:14px;flex-wrap:wrap}
    button.primary{background:var(--green);border:none;color:#fff;padding:10px 14px;border-radius:8px;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:8px;border:1px solid #e6e6e6}
    th{background:var(--green);color:#fff}
    .map-container{height:320px;border-radius:10px;overflow:hidden}
    input[type=text],input[type=number],textarea,select{width:100%;padding:8px;border-radius:8px;border:1px solid #ccc}
    .form-group{margin-bottom:10px}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#f1f8f1;color:var(--green);font-weight:600}
    .checklist label{display:flex;align-items:center;gap:8px;margin-bottom:8px}
    .phase{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .phase .dot{width:14px;height:14px;border-radius:50%;background:#ddd}
    .phase.complete .dot{background:var(--green)}
    .toast{position:fixed;top:20px;right:20px;background:var(--green);color:#fff;padding:10px 16px;border-radius:8px;z-index:2000}
    @media(max-width:800px){.sidebar{width:64px}.content{margin-left:64px}}
  </style>
</head>
<body>
  <div class="sidebar">
    <h3>Worker Dashboard</h3>
    <a class="nav-link" href="#">üè† Home</a>
    <a class="nav-link" href="#training">üéì Training</a>
    <a class="nav-link" href="#ppe">ü¶∫ PPE Check</a>
    <a class="nav-link" href="#gps">üìç GPS Route</a>
    <a class="nav-link" href="#collect">‚ôªÔ∏è Collect Waste</a>
    <a class="nav-link" href="#insurance">üìù Insurance</a>
    <a class="nav-link" href="#firstaid">üöë First Aid</a>
  </div>

  <div class="content">
    <div class="top-row">
      <div class="card small">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:12px;color:#666">Worker</div>
            <div style="font-weight:700">Ramesh Kumar</div>
          </div>
          <div class="badge">On Duty</div>
        </div>
        <div style="margin-top:10px;font-size:13px;color:#555">ID: W-0785</div>
      </div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-size:12px;color:#666">Today's Progress</div>
            <div style="font-weight:700;font-size:20px">3 / 6 Tasks</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:12px;color:#666">Certification</div>
            <div style="font-weight:700">Level 1</div>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="primary" id="startShiftBtn">Start Shift</button>
          <button onclick="saveSnapshot()">Save Snapshot</button>
        </div>
      </div>

      <div class="card small">
        <div style="font-size:12px;color:#666">Emergency</div>
        <div style="font-weight:700">üìû 112</div>
        <div style="margin-top:10px"><button onclick="openFirstAid()" class="primary">Open First Aid</button></div>
      </div>
    </div>

    <!-- Training Section -->
    <div id="training" class="section card">
      <h3>Phasewise Training & Certification</h3>
      <div style="display:flex;gap:20px;flex-wrap:wrap">
        <div style="flex:1;min-width:320px">
          <div id="phasesContainer"></div>
          <div style="margin-top:12px;display:flex;gap:8px">
            <select id="phaseSelect">
              <option value="Safety Basics">Safety Basics</option>
              <option value="Segregation 101">Segregation 101</option>
              <option value="Equipment Handling">Equipment Handling</option>
              <option value="First Aid">First Aid</option>
              <option value="Customer Interaction">Customer Interaction</option>
            </select>
            <button class="primary" id="markCompleteBtn">Mark Complete</button>
            <button id="uploadCertBtn">Upload Cert</button>
            <input id="certFile" type="file" style="display:none" />
          </div>
        </div>
        <div style="flex:1;min-width:280px">
          <div style="font-size:13px;color:#666">Certification Documents</div>
          <table>
            <thead><tr><th>Phase</th><th>Status</th><th>Document</th></tr></thead>
            <tbody id="certTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- PPE Check -->
    <div id="ppe" class="section card">
      <h3>PPE Daily Check</h3>
      <div style="display:flex;gap:18px;flex-wrap:wrap">
        <div style="flex:1;min-width:280px">
          <form id="ppeForm">
            <div class="form-group checklist">
              <label><input type="checkbox" name="helmet"/> Helmet</label>
              <label><input type="checkbox" name="gloves"/> Gloves</label>
              <label><input type="checkbox" name="boots"/> Safety Boots</label>
              <label><input type="checkbox" name="vest"/> Reflective Vest</label>
              <label><input type="checkbox" name="mask"/> Mask</label>
            </div>
            <div class="form-group">
              <textarea id="ppeNotes" placeholder="Notes (damage, replacement needed)"></textarea>
            </div>
            <div style="display:flex;gap:8px"><button class="primary" type="button" id="submitPPE">Submit Check</button><button type="button" id="resetPPE">Reset</button></div>
          </form>
        </div>
        <div style="flex:1;min-width:260px">
          <div style="font-size:13px;color:#666">PPE Log</div>
          <table>
            <thead><tr><th>Time</th><th>Checklist OK</th><th>Notes</th></tr></thead>
            <tbody id="ppeLogBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- GPS Route -->
    <div id="gps" class="section card">
      <h3>GPS Route & Checkpoints</h3>
      <div style="display:flex;gap:14px;flex-wrap:wrap">
        <div style="flex:1;min-width:320px">
          <div class="map-container" id="map"></div>
          <div style="margin-top:8px;display:flex;gap:8px">
            <button class="primary" id="startRoute">Start Route</button>
            <button id="addCheckpoint">Add Checkpoint</button>
            <button id="clearRoute">Clear Route</button>
          </div>
        </div>
        <div style="flex:0 0 320px">
          <div style="font-size:13px;color:#666">Checkpoints</div>
          <ol id="cpList"></ol>
        </div>
      </div>
    </div>

    <!-- Collect Segregated Waste -->
    <div id="collect" class="section card">
      <h3>Collect Segregated Waste</h3>
      <div style="display:flex;gap:16px;flex-wrap:wrap">
        <div style="flex:1;min-width:320px">
          <form id="collectForm">
            <div class="form-group">
              <select id="wasteType">
                <option value="Paper">Paper</option>
                <option value="Plastic">Plastic</option>
                <option value="Metal">Metal</option>
                <option value="Organic">Organic</option>
                <option value="Glass">Glass</option>
              </select>
            </div>
            <div class="form-group">
              <input type="number" id="wasteQty" placeholder="Quantity (kg)" />
            </div>
            <div class="form-group">
              <input type="text" id="locationNote" placeholder="Location / Customer" />
            </div>
            <div style="display:flex;gap:8px"><button class="primary" id="addCollect">Add</button><button id="clearCollect">Clear</button></div>
          </form>
        </div>
        <div style="flex:1;min-width:260px">
          <canvas id="collectChart" style="max-width:100%"></canvas>
          <div style="margin-top:10px">
            <table>
              <thead><tr><th>Type</th><th>Qty (kg)</th><th>Where</th></tr></thead>
              <tbody id="collectTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Insurance Claim -->
    <div id="insurance" class="section card">
      <h3>Insurance Claim</h3>
      <div style="display:flex;gap:18px;flex-wrap:wrap">
        <div style="flex:1;min-width:320px">
          <form id="claimForm">
            <div class="form-group"><input id="claimId" placeholder="Claim ID (auto or enter)"/></div>
            <div class="form-group"><input id="incidentType" placeholder="Incident Type (injury/equipment)"/></div>
            <div class="form-group"><textarea id="incidentDesc" placeholder="Description"></textarea></div>
            <div class="form-group"><input id="claimAmount" type="number" placeholder="Estimated Amount"/></div>
            <div style="display:flex;gap:8px"><button class="primary" id="submitClaim">Submit Claim</button><button id="clearClaim">Clear</button></div>
          </form>
        </div>
        <div style="flex:1;min-width:260px">
          <div style="font-size:13px;color:#666">Claims Log</div>
          <table>
            <thead><tr><th>Claim ID</th><th>Type</th><th>Amount</th><th>Status</th></tr></thead>
            <tbody id="claimsTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- First Aid -->
    <div id="firstaid" class="section card">
      <h3>First Aid & Incident Report</h3>
      <div style="display:flex;gap:18px;flex-wrap:wrap">
        <div style="flex:1;min-width:320px">
          <div style="font-weight:700">Quick Steps</div>
          <ol>
            <li>Ensure area safety</li>
            <li>Call emergency services if needed</li>
            <li>Stabilize injured person</li>
            <li>Use first aid kit (bandage, compress)</li>
            <li>Report incident and file claim</li>
          </ol>
          <div style="margin-top:10px"><button class="primary" onclick="openFirstAid()">Open Incident Form</button></div>
        </div>
        <div style="flex:1;min-width:260px">
          <div style="font-size:13px;color:#666">Incident Log</div>
          <table>
            <thead><tr><th>Time</th><th>Type</th><th>Notes</th></tr></thead>
            <tbody id="incidentTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div style="height:60px"></div>
  </div>

  <!-- Toast container -->
  <div id="toast"></div>

  <!-- Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j7g2kQ0b1v0gq3xwqfY2gS1kYk5a8n+v+2Qm0jk=" crossorigin=""></script>

  <script>
    // Simple toast
    function showToast(msg, timeout=3000){const t=document.getElementById('toast');t.textContent=msg;t.className='toast';setTimeout(()=>t.className='',timeout)}

    // --- Training & Certification ---
    const PHASES = ['Safety Basics','Segregation 101','Equipment Handling','First Aid','Customer Interaction'];
    const phasesContainer = document.getElementById('phasesContainer');
    const certTableBody = document.getElementById('certTableBody');
    const certFile = document.getElementById('certFile');

    function loadState(){
      const state = JSON.parse(localStorage.getItem('worker_dashboard')||'{}');
      return state;
    }
    function saveState(s){localStorage.setItem('worker_dashboard',JSON.stringify(s));}

    let state = loadState();
    if(!state.phases) state.phases = PHASES.map(p=>({name:p,complete:false,doc:null}));

    function renderPhases(){
      phasesContainer.innerHTML='';certTableBody.innerHTML='';
      state.phases.forEach((p,i)=>{
        const div = document.createElement('div');div.className='phase '+(p.complete? 'complete':'');
        div.innerHTML=`<div class="dot"></div><div style="flex:1"><strong>${p.name}</strong><div style="font-size:12px;color:#666">${p.complete? 'Completed':'Pending'}</div></div><div><button data-i="${i}" class="uploadBtn">View</button></div>`;
        phasesContainer.appendChild(div);

        const tr = document.createElement('tr');
        tr.innerHTML=`<td>${p.name}</td><td>${p.complete? 'Complete':'Pending'}</td><td>${p.doc? '<a href="'+p.doc+'" target="_blank">View</a>' : '-'}</td>`;
        certTableBody.appendChild(tr);
      });
    }
    renderPhases();

    document.getElementById('markCompleteBtn').addEventListener('click',()=>{
      const sel = document.getElementById('phaseSelect').value;
      const idx = state.phases.findIndex(x=>x.name===sel);
      if(idx>=0){state.phases[idx].complete=true;saveState(state);renderPhases();showToast('Phase marked complete')}
    });

    document.getElementById('uploadCertBtn').addEventListener('click',()=>certFile.click());
    certFile.addEventListener('change',e=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=>{
        const sel = document.getElementById('phaseSelect').value;
        const idx = state.phases.findIndex(x=>x.name===sel);
        state.phases[idx].doc = reader.result; saveState(state); renderPhases(); showToast('Certificate uploaded (local)');
      };
      reader.readAsDataURL(file);
    });

    // --- PPE Check ---
    const ppeForm = document.getElementById('ppeForm');
    const ppeLogBody = document.getElementById('ppeLogBody');
    document.getElementById('submitPPE').addEventListener('click',()=>{
      const form = new FormData(ppeForm); const items=[]; for(const [k,v] of form.entries()){ if(v==='on') items.push(k); }
      const notes = document.getElementById('ppeNotes').value;
      const time = new Date().toLocaleString();
      const ok = items.length>=4 ? 'Yes':'Partial';
      const row = {time,ok,notes};
      state.ppeLog = state.ppeLog||[]; state.ppeLog.unshift(row); saveState(state); renderPPE(); showToast('PPE logged');
      ppeForm.reset(); document.getElementById('ppeNotes').value = '';
    });
    document.getElementById('resetPPE').addEventListener('click',()=>{ppeForm.reset();});
    function renderPPE(){ ppeLogBody.innerHTML='';(state.ppeLog||[]).forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.time}</td><td>${r.ok}</td><td>${r.notes||'-'}</td>`;ppeLogBody.appendChild(tr)});}
    renderPPE();

    // --- GPS Map & Route ---
    const map = L.map('map',{center:[22.5726,88.3639],zoom:12});
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
    let routeCoords = state.routeCoords || [];
    let routeLine = null;
    function drawRoute(){ if(routeLine) map.removeLayer(routeLine); if(routeCoords.length) routeLine = L.polyline(routeCoords,{color:'green'}).addTo(map); }
    drawRoute();
    document.getElementById('startRoute').addEventListener('click',()=>{
      if(!navigator.geolocation){showToast('Geolocation not supported');return}
      showToast('Tracking location...');
      navigator.geolocation.getCurrentPosition(pos=>{
        const c=[pos.coords.latitude,pos.coords.longitude]; routeCoords.push(c); saveRoute(); drawRoute(); map.setView(c,15); addCheckpointToList(c,'Start');
      },err=>{showToast('Unable to get location')});
    });
    document.getElementById('addCheckpoint').addEventListener('click',()=>{
      if(!navigator.geolocation){showToast('Geolocation not supported');return}
      navigator.geolocation.getCurrentPosition(pos=>{const c=[pos.coords.latitude,pos.coords.longitude]; routeCoords.push(c); saveRoute(); drawRoute(); addCheckpointToList(c,'Checkpoint');},()=>showToast('Unable to get location'));
    });
    document.getElementById('clearRoute').addEventListener('click',()=>{routeCoords=[];saveRoute();drawRoute();renderCPList();});
    function saveRoute(){ state.routeCoords = routeCoords; saveState(state); }
    function addCheckpointToList(c,label){ state.checkpoints = state.checkpoints||[]; const entry = {lat:c[0],lng:c[1],label,label,time:new Date().toLocaleString()}; state.checkpoints.push(entry); saveState(state); renderCPList(); L.marker(c).addTo(map).bindPopup(label).openPopup(); }
    function renderCPList(){ const ol = document.getElementById('cpList'); ol.innerHTML='';(state.checkpoints||[]).forEach(cp=>{const li=document.createElement('li');li.textContent=`${cp.label} @ ${cp.time} (${cp.lat.toFixed(4)}, ${cp.lng.toFixed(4)})`;ol.appendChild(li)})}
    renderCPList();

    // --- Collect Segregated Waste ---
    const collectForm = document.getElementById('collectForm');
    const collectTable = document.getElementById('collectTable');
    const ctx = document.getElementById('collectChart').getContext('2d');
    const collectData = state.collectData || {labels:[],data:[]};
    const collectChart = new Chart(ctx,{type:'doughnut',data:{labels:collectData.labels,datasets:[{data:collectData.data}]},options:{responsive:true}});

    document.getElementById('addCollect').addEventListener('click',()=>{
      const type = document.getElementById('wasteType').value; const qty = parseFloat(document.getElementById('wasteQty').value)||0; const where = document.getElementById('locationNote').value || '-';
      if(qty<=0){showToast('Enter positive quantity');return}
      state.collection = state.collection || [];
      state.collection.unshift({type,qty,where,time:new Date().toLocaleString()});
      // aggregate
      const idx = collectData.labels.indexOf(type);
      if(idx===-1){collectData.labels.push(type);collectData.data.push(qty);} else {collectData.data[idx]+=qty}
      state.collectData = collectData; saveState(state);
      renderCollection(); collectChart.update(); document.getElementById('wasteQty').value=''; document.getElementById('locationNote').value=''; showToast('Collected recorded');
    });
    document.getElementById('clearCollect').addEventListener('click',()=>{state.collection=[];state.collectData={labels:[],data:[]};saveState(state);renderCollection();collectChart.data.labels=[];collectChart.data.datasets[0].data=[];collectChart.update();});
    function renderCollection(){ collectTable.innerHTML='';(state.collection||[]).forEach(c=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${c.type}</td><td>${c.qty}</td><td>${c.where}</td>`;collectTable.appendChild(tr)}); }
    renderCollection();

    // --- Insurance Claim ---
    document.getElementById('submitClaim').addEventListener('click',()=>{
      const id = document.getElementById('claimId').value || ('CL-'+Math.floor(Math.random()*9000+1000));
      const type = document.getElementById('incidentType').value||'Other';
      const desc = document.getElementById('incidentDesc').value||'-';
      const amt = parseFloat(document.getElementById('claimAmount').value)||0;
      state.claims = state.claims || [];
      state.claims.unshift({id,type,desc,amt,status:'Submitted',time:new Date().toLocaleString()}); saveState(state); renderClaims(); showToast('Claim submitted');
      document.getElementById('claimForm').reset();
    });
    document.getElementById('clearClaim').addEventListener('click',()=>{document.getElementById('claimForm').reset();});
    function renderClaims(){ const t = document.getElementById('claimsTable'); t.innerHTML='';(state.claims||[]).forEach(c=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${c.id}</td><td>${c.type}</td><td>${c.amt}</td><td>${c.status}</td>`;t.appendChild(tr)})}
    renderClaims();

    // --- First Aid / Incident ---
    function openFirstAid(){ const notes = prompt('Incident notes (brief):'); if(notes){state.incidents = state.incidents||[]; state.incidents.unshift({time:new Date().toLocaleString(),type:'Manual',notes}); saveState(state); renderIncidents(); showToast('Incident recorded') }}
    function renderIncidents(){ const t = document.getElementById('incidentTable'); t.innerHTML='';(state.incidents||[]).forEach(i=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${i.time}</td><td>${i.type}</td><td>${i.notes}</td>`;t.appendChild(tr)})}
    renderIncidents();

    // --- Misc controls ---
    document.getElementById('startShiftBtn').addEventListener('click',()=>{ showToast('Shift started'); });
    function saveSnapshot(){ localStorage.setItem('worker_snapshot_'+Date.now(), JSON.stringify(state)); showToast('Snapshot saved locally') }

    // initial saves
    saveState(state);
  </script>
</body>
</html>
